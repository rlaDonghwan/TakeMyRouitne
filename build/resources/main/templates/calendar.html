<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <!-- Axios 및 FullCalendar 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>

    <!-- Bootstrap CSS 및 FullCalendar 스타일 추가 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/main.min.css">

    <!-- 기타 스타일 및 설정 -->
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
        }

        #calendar {
            max-width: 1100px;
            margin: 40px auto;
        }
    </style>
</head>
<body>

<div id='calendar'></div>

<!-- 추가된 부분: 모달 -->
<div class="modal" tabindex="-1" role="dialog" id="eventModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Event Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="eventTitle">Title</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="eventTime">Time</label>
                        <div class="input-group date">
                            <input type="datetime-local" class="form-control" id="eventTime" required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="currentTimeButton">Now
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="eventContent">Content</label>
                        <textarea class="form-control" id="eventContent" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="eventPlace">Place</label>
                        <input type="text" class="form-control" id="eventPlace" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveButton">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- 추가된 부분: Update 모달 -->
<!-- 추가된 부분: 모달 -->
<div class="modal" tabindex="-1" role="dialog" id="updateEventModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Event</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="updateEventTitle">Title</label>
                        <input type="text" class="form-control" id="updateEventTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="updateEventTime">Time</label>
                        <div class="input-group date">
                            <input type="datetime-local" class="form-control" id="updateEventTime" required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="updateCurrentTimeButton">
                                    Now
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="deleteEventButton">Delete</button>
                <button type="button" class="btn btn-primary" id="updateEventSaveButton">Save changes</button>
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap 및 FullCalendar 스크립트 추가 -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>


<!-- FullCalendar 스크립트 추가 -->
<script>


    // 함수로 userId 가져오기
    function getUserId() {
        return sessionStorage.getItem('userId');
    }

    document.addEventListener('DOMContentLoaded', function () {

        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            timeZone: 'UTC',
            initialView: 'dayGridMonth',
            events: function (fetchInfo, successCallback, failureCallback) {
                // Axios를 사용하여 Ajax 요청
                axios.get('/home/calendar/events', { //이벤트 추가
                    params: {
                        start: fetchInfo.startStr,
                        end: fetchInfo.endStr
                    }
                })
                    .then(function (response) {
                        // 성공적으로 데이터를 받아온 경우
                        var events = response.data;
                        successCallback(events);
                    })
                    .catch(function (error) {
                        // 오류가 발생한 경우
                        console.error('Error fetching events', error);
                        failureCallback(error);
                    });
            },
            editable: true,
            selectable: true,
            dateClick: function (info) {
                // 날짜를 클릭할 때의 동작
                $('#eventModal').modal('show');
            },
            eventClick: function (info) {
                // 이벤트를 클릭할 때의 동작
                selectedEvent = info.event; // 클릭한 이벤트 저장

                // 이벤트 수정 모달 띄우기
                $('#updateEventModal').modal('show');
                // 모달에 이벤트 정보 세팅
                $('#updateEventTitle').val(selectedEvent.title);
                $('#updateEventTime').val(selectedEvent.start.toISOString().slice(0, 16));
            }
        });

        calendar.render();


    });

    // 추가된 부분: 이벤트 추가 함수
    function addEvent() {
        var title = $('#eventTitle').val();
        var time = $('#eventTime').val();
        var content = $('#eventContent').val();
        var place = $('#eventPlace').val();

        // 'time' 값을 'date'로 변경하여 파라미터 추가
        var date = time.split('T')[0] + ' ' + time.split('T')[1] + ":00";
        // 'date' 문자열을 JavaScript Date 객체로 변환
        var jsDate = new Date(date);
        // LocalDateTime으로 변환
        var localDateTime = jsDate.toISOString().replace(/Z$/, '');

        // 함수로 userId 가져오기
        function getUserId() {
            return sessionStorage.getItem('userId');
        }

        // Axios를 사용하여 서버에 이벤트 추가 요청
        axios.post('/home/calendar/addEvent', null, {
            params: {
                title: title,
                date: localDateTime,
                time: time,
                content: content,
                place: place,
                userId: getUserId()  // 함수로 userId 추가
            }
        })
            .then(function (response) {
                location.reload();
                console.log('Event added successfully', response);
                // FullCalendar 새로고침
                calendar.refetchEvents();

                // 화면 새로고침
                location.reload();
            })
            .catch(function (error) {
                console.error('Error adding event', error);
            });
    }




    // 추가된 부분: Now 버튼 클릭 시 현재 시간 입력
    $('#currentTimeButton').on('click', function () {
        var currentDate = new Date();
        var localDate = new Date(currentDate.getTime() - currentDate.getTimezoneOffset() * 60000);
        var formattedDate = localDate.toISOString().slice(0, 16);

        // 사용자의 로컬 시간대에서 ISO 8601 형식의 값을 datetime-local 필드에 설정
        $('#eventTime').val(formattedDate);
    });


    // 추가된 부분: Save 버튼 클릭 시 이벤트 추가
    $('#saveButton').on('click', function () {
        addEvent();
        $('#eventModal').modal('hide');
    });

    function updateEvent() {
        var title = $('#updateEventTitle').val();
        var time = $('#updateEventTime').val();

        // 'time' 값을 'date'로 변경하여 파라미터 추가
        var date = time.split('T')[0] + ' ' + time.split('T')[1] + ":00";
        // 'date' 문자열을 JavaScript Date 객체로 변환
        var jsDate = new Date(date);
        // LocalDateTime으로 변환
        var localDateTime = jsDate.toISOString().replace(/Z$/, '');

        // 추가된 부분: 서버에 이벤트 수정 요청
        axios.put('/home/calendar/updateEvent', {
            todoId: selectedEvent.id, // 클릭한 이벤트의 todoId 전달
            title: title,
            date: localDateTime,
            time: time,
            userId: getUserId()  // 함수로 userId 추가
        })
            .then(function (response) {
                location.reload();
                console.log('Event updated successfully', response);
            })
            .catch(function (error) {
                console.error('Error updating event', error);
            });
    }

    // 추가된 부분: Update 모달 Now 버튼 클릭 시 현재 시간 입력
    $('#updateCurrentTimeButton').on('click', function () {
        var currentDate = new Date();
        var localDate = new Date(currentDate.getTime() - currentDate.getTimezoneOffset() * 60000);
        var formattedDate = localDate.toISOString().slice(0, 16);

        // 사용자의 로컬 시간대에서 ISO 8601 형식의 값을 datetime-local 필드에 설정
        $('#updateEventTime').val(formattedDate);
    });


    <!-- 추가된 부분: Update 모달 Save 버튼 클릭 시 이벤트 수정 -->

    // Update 모달 Save 버튼 클릭 시 이벤트 수정
    $('#updateEventSaveButton').on('click', function () {
        updateEvent();
        $('#updateEventModal').modal('hide');
    });

    // 추가된 부분: 이벤트 삭제 함수
    function deleteEvent() {
        // 함수로 userId 가져오기
        function getUserId() {
            return sessionStorage.getItem('userId');
        }

        // Axios를 사용하여 서버에 이벤트 삭제 요청
        axios.delete('/home/calendar/deleteEvent', {
            params: {
                todoId: selectedEvent.id,
                userId: getUserId()
            }
        })
            .then(function (response) {
                // 성공적으로 삭제된 경우의 동작
                location.reload();
                console.log('Event deleted successfully', response);
            })
            .catch(function (error) {
                // 삭제 중 오류가 발생한 경우의 동작
                console.error('Error deleting event', error);
            });

    }

    // 추가된 부분: Update 모달 Delete 버튼 클릭 시 이벤트 삭제
    $('#deleteEventButton').on('click', function () {
        deleteEvent();
        $('#updateEventModal').modal('hide');
    });


</script>

</body>
</html>
